---
title: "Agricultural Land Cover and Pacific Salmonid Habitat"
author: "Sydney Schmitter"
date: "6/14/2022"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
---
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Load libraries
library(tidyverse)
library(ggthemes)
library(janitor)
library(sf)
library(stars)
library(ggspatial)
library(units)
library(cowplot)
library(knitr)
library(kableExtra)
library(CropScapeR)
library(tigris)
library(ggplot2)
library(cdlTools)
library(terra)
library(raster)
library(tabularaster)
library(here)
library(tmap)

setwd("~/Desktop/Github Repo/salmon_ag")

# Set ggplot2 themes
theme_set(theme_clean())
theme_update(
  plot.background = element_rect(color = NA),
  plot.title.position = "plot",
  plot.caption.position = "plot"
)
```

```{r data-prep, echo=FALSE, message=FALSE, include=FALSE}
#create map of area of study, salmon habitat, Pacific Northwest, Pacific coast
# statedata <- tigris::counties(state = c("CA","WA","ID","OR"), cb = TRUE) %>% 
#   st_as_sf() 
# 
# regionmap <- ggplot() +
#   geom_sf(data = statedata) +
#   geom_sf(data = statedata, fill = "lightblue") +
#   theme_void()

#download data for individual states from https://nassgeodata.gmu.edu/CropScape/
Washingtontif = raster('Washington.tif')
Washington <- Washingtontif
Oregontif = raster('Oregon.tif')
Oregon <- Oregontif
Idahotif = raster('Idaho.tif')
Idaho <- Idahotif
Californiatif = raster('California.tif')
California <- Californiatif
CDLtif = raster('cdl_west.tif')
CDLwest <- CDLtif

#I downloaded an additional file for national cropscape data from https://www.nass.usda.gov/Research_and_Science/Cropland/Release/index.php 
Nationaltif = raster('National.tif')
National <- Nationaltif

#merge state data to create a single object for the region of study. this took a long time but worked
# region_data <- raster::merge(California, Idaho, Washington, Oregon, overlap = TRUE)

#plot to make sure map looks correct. The merge looks wonky. Check in with all about this.
# plot(region_data)

#write and store raster for downstream use
# writeRaster(region_data, "cdl_west.tif", format = "GTiff", overwrite = TRUE)
# region_data <- raster(paste0(here("data"), "/cdl_west.tif"))

#Import recovery subdomain shapefile
sf_recoverydomain <- st_read(paste0(file.path("data"), "/recovery_subdomains/subdomains-ver7.shp")) %>% clean_names()

sf_recoverydomain <-
  sf_recoverydomain %>%
  distinct(.keep_all = TRUE) %>%
  #filter to see only class that is Accessible
  dplyr::filter(`class` == "Accessible") %>%
  #condense and generalize data, all species names with "Chinook" in it just become "Chinook"
  mutate(
    species2 = case_when(
      species == "Steelhead" ~ "Steelhead",
      str_detect(species, "Chinook") ~ "Chinook",
      str_detect(species, "Chum") ~ "Chum",
      str_detect(species, "Pink") ~ "Pink",
      TRUE ~ species
    ),
    #if species is steelhead, change it to trout, otherwise it's a salmon
    species3 = case_when(
      species == "Steelhead" ~ "Trout",
      TRUE ~ "Salmon"
    ),
    #clean up subdomain names
    domain = case_when(
      subdomain == "Washington Coast" ~ "Puget Sound",
      subdomain == "Snake River" ~ "Interior Columbia",
      subdomain == "Middle Columbia River" ~ "Interior Columbia",
      subdomain == "Upper Columbia River" ~ "Interior Columbia",
      subdomain == "Lower Columbia River" ~ "Willamette/Lower Columbia",
      subdomain == "Upper Willamette River" ~ "Willamette/Lower Columbia",
      subdomain == "California Central Valley" ~ "Central Valley",
      subdomain == "North-Central California Coast" ~ "North-Central California Coast",
      TRUE ~ subdomain
    ),
    area = st_area(geometry),
    area = set_units(area, km^2)
  )%>%
  st_transform(CDLwest@crs)

#Find area for each species, group into endangered, threatened, concern.
df_rd_species <-
  sf_recoverydomain %>%
  st_drop_geometry() %>%
  mutate(
    area = set_units(area, km^2),
    area_endangered = area * as.numeric(I(status == "Endangered")),
    area_threatened = area * as.numeric(I(status == "Threatened")),
    area_concern = area * as.numeric(I(status == "Species of Concern"))
  ) %>%
  group_by(species) %>%
  summarize(
    n_domain = n_distinct(subdomain),
    n_endangered = sum(status == "Endangered"),
    n_threatened = sum(status == "Threatened"),
    n_concern = sum(status == "Species of Concern"),
    area_tot = sum(area),
    area_endangered = sum(area_endangered),
    area_threatened = sum(area_threatened),
    area_concern = sum(area_concern)
  )
df_rd_species

#Find further simplify to just species names

df_rd_species2 <-
  sf_recoverydomain %>%
  st_drop_geometry() %>%
  filter(species != "Not Warranted") %>%
  mutate(
    area = set_units(area, km^2),
    area_endangered = area * as.numeric(I(status == "Endangered")),
    area_threatened = area * as.numeric(I(status == "Threatened")),
    area_concern = area * as.numeric(I(status == "Species of Concern"))
  ) %>%
  group_by(species2) %>%
  summarize(
    n_domain = n_distinct(subdomain),
    n_endangered = sum(status == "Endangered"),
    n_threatened = sum(status == "Threatened"),
    n_concern = sum(status == "Species of Concern"),
    area_tot = sum(area),
    area_endangered = sum(area_endangered),
    area_threatened = sum(area_threatened),
    area_concern = sum(area_concern)
  )
df_rd_species2

#group by subdomain and summarize, you're left with subdomain and geometry only
sf_recoverydomain_merge <-
  sf_recoverydomain %>%
  group_by(subdomain) %>%
   summarize()

#sf_recoverydomain_merge <- st_union(sf_recoverydomain$geometry, sf_recoverydomain$subdomain)

# Compute acreage summaries using CDL
# Set CRS to match
sf_recoverydomain <-
  sf_recoverydomain %>%
  st_transform(CDLwest@crs)

#Break up full count for memory management
# Full count 1: 1 - 10
df_crdcount_1 <-
  freq(
    sf = sf_recoverydomain %>% arrange(area) %>% slice(1:10),
    cdl = CDLwest
  ) %>%
  st_drop_geometry()




# Full count 2: 11 - 20
df_crdcount_2 <-
  count_cdl_pixels(
    sf = sf_recoverydomain %>% arrange(area) %>% slice(11:20),
    cdl = CDLwest
  ) %>%
  st_drop_geometry()
# Full count 3: 21 - 30
df_crdcount_3 <-
  count_cdl_pixels(
    sf = sf_recoverydomain %>% arrange(area) %>% slice(21:30),
    cdl = CDLwest
  ) %>%
  st_drop_geometry()
# Full count 3: 31 - 40
df_crdcount_4 <-
  count_cdl_pixels(
    sf = sf_recoverydomain %>% arrange(area) %>% slice(31:40),
    cdl = CDLwest
  ) %>%
  st_drop_geometry()

# Combine
df_crdcount <-
  bind_rows(df_crdcount_1, df_crdcount_2, df_crdcount_3, df_crdcount_4)
rm(df_crdcount_1, df_crdcount_2, df_crdcount_3, df_crdcount_4)

# Save
write_csv(df_crdcount, "data_subdomains_crd.csv")
df_crdcount <- read_csv(paste0(here("data"), "/data_subdomains_crd.csv"))
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
